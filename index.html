<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>iPhone Chrome JS Capability Snapshot</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 16px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    button { padding: 10px 12px; font-size: 14px; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 8px; overflow: auto; white-space: pre-wrap; word-break: break-word; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
    .hint { color: #666; font-size: 12px; margin-top: 6px; }
  </style>
</head>
<body>
  <h1>JS 能力画像采样（iPhone / iOS Chrome）</h1>
  <div class="row">
    <button id="btnRefresh">重新采样</button>
    <button id="btnCopy">复制 JSON</button>
  </div>
  <pre id="out">Loading...</pre>
  <div class="hint">
    提示：用 iPhone Chrome 打开本页，点“复制 JSON”，粘贴回你桌面 Chromium 的对比结果即可。
  </div>

<script>
(function () {
  function safe(fn, fallback = null) {
    try { return fn(); } catch (e) { return fallback; }
  }

  function getWebGLInfo() {
    const canvas = document.createElement('canvas');
    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
    if (!gl) return { supported: false };

    const debug = gl.getExtension('WEBGL_debug_renderer_info');
    const vendor = debug ? gl.getParameter(debug.UNMASKED_VENDOR_WEBGL) : null;
    const renderer = debug ? gl.getParameter(debug.UNMASKED_RENDERER_WEBGL) : null;

    return {
      supported: true,
      version: safe(() => gl.getParameter(gl.VERSION)),
      shadingLanguageVersion: safe(() => gl.getParameter(gl.SHADING_LANGUAGE_VERSION)),
      vendorMasked: safe(() => gl.getParameter(gl.VENDOR)),
      rendererMasked: safe(() => gl.getParameter(gl.RENDERER)),
      vendorUnmasked: vendor,
      rendererUnmasked: renderer,
      extensionsCount: safe(() => gl.getSupportedExtensions().length, null)
    };
  }

  function getUAData() {
    const uad = navigator.userAgentData;
    if (!uad) return null;

    // brands 可能是 BrandVersion 数组
    const brands = safe(() => uad.brands || uad.uaList, null);

    return {
      platform: safe(() => uad.platform, null),
      mobile: safe(() => uad.mobile, null),
      brands: brands,
      // getHighEntropyValues 在 iOS 上通常不可用/行为不同，做成可选项
      highEntropy: safe(() => {
        if (!uad.getHighEntropyValues) return null;
        return uad.getHighEntropyValues([
          "architecture","bitness","model","platform","platformVersion",
          "uaFullVersion","fullVersionList","wow64"
        ]);
      }, null)
    };
  }

  async function snapshot() {
    const nav = navigator;

    const data = {
      meta: {
        capturedAt: new Date().toISOString(),
        locationHint: safe(() => Intl.DateTimeFormat().resolvedOptions().timeZone, null),
        page: { href: location.href }
      },

      navigator: {
        userAgent: nav.userAgent,
        platform: safe(() => nav.platform, null),
        vendor: safe(() => nav.vendor, null),
        language: safe(() => nav.language, null),
        languages: safe(() => nav.languages, null),
        hardwareConcurrency: safe(() => nav.hardwareConcurrency, null),
        deviceMemory: safe(() => nav.deviceMemory, null),
        maxTouchPoints: safe(() => nav.maxTouchPoints, null),
        webdriver: safe(() => nav.webdriver, null),
        cookieEnabled: safe(() => nav.cookieEnabled, null),
        doNotTrack: safe(() => nav.doNotTrack, null),
        userAgentData: getUAData()
      },

      window: {
        // iOS/桌面差异点
        hasWindowChrome: !!window.chrome,
        devicePixelRatio: safe(() => window.devicePixelRatio, null),
        innerWidth: safe(() => window.innerWidth, null),
        innerHeight: safe(() => window.innerHeight, null)
      },

      mediaQueries: {
        hoverHover: safe(() => matchMedia("(hover: hover)").matches, null),
        hoverNone: safe(() => matchMedia("(hover: none)").matches, null),
        pointerCoarse: safe(() => matchMedia("(pointer: coarse)").matches, null),
        pointerFine: safe(() => matchMedia("(pointer: fine)").matches, null),
        anyHover: safe(() => matchMedia("(any-hover: hover)").matches, null),
        anyPointerCoarse: safe(() => matchMedia("(any-pointer: coarse)").matches, null),
        prefersReducedMotion: safe(() => matchMedia("(prefers-reduced-motion: reduce)").matches, null),
        prefersColorSchemeDark: safe(() => matchMedia("(prefers-color-scheme: dark)").matches, null)
      },

      capabilities: {
        mediaDevices: !!(nav.mediaDevices && nav.mediaDevices.enumerateDevices),
        rtcPeerConnection: !!window.RTCPeerConnection,
        serviceWorker: "serviceWorker" in nav,
        webAssembly: "WebAssembly" in window,
        sharedArrayBuffer: "SharedArrayBuffer" in window,
        bluetooth: "bluetooth" in nav,
        clipboard: !!(nav.clipboard && nav.clipboard.writeText),
        geolocation: "geolocation" in nav,
        deviceMotionEvent: "DeviceMotionEvent" in window,
        deviceOrientationEvent: "DeviceOrientationEvent" in window
      },

      webgl: getWebGLInfo()
    };

    // 如果 highEntropy 是 Promise（Chromium 系），await 一下
    if (data.navigator.userAgentData && data.navigator.userAgentData.highEntropy instanceof Promise) {
      data.navigator.userAgentData.highEntropy = await data.navigator.userAgentData.highEntropy.catch(() => null);
    }

    return data;
  }

  async function render() {
    const out = document.getElementById("out");
    out.textContent = "Sampling...";
    const data = await snapshot();
    window.__CAP_SNAPSHOT__ = data;
    out.textContent = JSON.stringify(data, null, 2);
  }

  document.getElementById("btnRefresh").addEventListener("click", render);

  document.getElementById("btnCopy").addEventListener("click", async () => {
    const txt = JSON.stringify(window.__CAP_SNAPSHOT__ ?? {}, null, 2);
    try {
      await navigator.clipboard.writeText(txt);
      alert("已复制到剪贴板");
    } catch (e) {
      // iOS 可能剪贴板权限限制，退化：选中输出让你手动复制
      const out = document.getElementById("out");
      const range = document.createRange();
      range.selectNodeContents(out);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      alert("无法直接写剪贴板：已选中文本，请手动复制");
    }
  });

  render();
})();
</script>
</body>
</html>
